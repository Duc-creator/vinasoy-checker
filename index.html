<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCR Date Checker</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 10px; background: #f8f8f8; }
    h1 { color: #333; }
    textarea, input, select, button {
      padding: 10px; margin: 10px 0; font-size: 1em; width: 90%; max-width: 400px;
    }
    button { background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; }
    button:active { background: #0056b3; }
    #result { font-size: 1.5em; margin-top: 10px; font-weight: bold; }
    .ok { color: green; }
    .fail { color: red; }
    #ocrText { white-space: pre-line; font-size: 1em; color: #333; margin-top: 10px; background: #fff;
      padding: 10px; border-radius: 8px; max-width: 400px; margin: auto; }
    .camera-wrapper { position: relative; display: inline-block; }
    video { border: 2px solid #ccc; border-radius: 8px; margin: 10px 0; width: 320px; height: 240px; object-fit: cover; }
    #overlay {
      position: absolute; border: 2px solid rgba(255, 0, 0, 0.7); pointer-events: none;
      top: 50%; left: 50%; width: 150px; height: 50px; transform: translate(-50%, -50%);
      box-shadow: 0 0 10px rgba(255,0,0,0.5);
    }
  </style>
</head>
<body>
  <h1>OCR Date Checker</h1>

  <!-- C√°c ph·∫ßn giao di·ªán gi·ªØ nguy√™n -->
  <div>
    <label for="shelfLife">H·∫°n s·ª≠ d·ª•ng (th√°ng):</label>
    <select id="shelfLife">
      <option value="6">6 th√°ng</option>
      <option value="9">9 th√°ng</option>
      <option value="10">10 th√°ng</option>
    </select>
  </div>
  <div>
    <label for="batchCode">M√£ l√¥ (3 k√Ω t·ª±):</label>
    <input type="text" id="batchCode" maxlength="3" placeholder="VD: 086">
  </div>
  <div>
    <label for="weekday">Th·ª© h√¥m nay:</label>
    <input type="text" id="weekday" readonly>
  </div>
  <div>
    <label>
      <input type="checkbox" id="singleLineCheck"> Ch·ªâ t·∫°o cho 1 line
    </label>
  </div>
  <div id="lineSelectWrapper" style="display:none;">
    <label for="lineSelect">Ch·ªçn line:</label>
    <select id="lineSelect">
      <option value="A">A</option>
      <option value="B">B</option>
      <option value="C">C</option>
      <option value="D">D</option>
      <option value="E">E</option>
      <option value="F">F</option>
      <option value="G">G</option>
      <option value="H">H</option>
      <option value="I">I</option>
    </select>
  </div>

  <button id="generateBtn">T·∫°o danh s√°ch date</button>
  <textarea id="dateList" rows="10" placeholder="Danh s√°ch date code..."></textarea>

  <button id="captureBtn">üì∑ Ch·ª•p & OCR</button>

  <div class="camera-wrapper">
    <video id="video" autoplay playsinline></video>
    <div id="overlay"></div>
  </div>
  <canvas id="canvas" width="320" height="240" style="display:none"></canvas>

  <div id="result"></div>
  <div id="ocrText"></div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resultDiv = document.getElementById('result');
    const ocrTextDiv = document.getElementById('ocrText');
    const targetTextArea = document.getElementById('dateList');

    function updateWeekday() {
      const today = new Date();
      const day = today.getDay();
      const weekday = (day === 0) ? 1 : day + 1;
      document.getElementById('weekday').value = weekday;
    }
    updateWeekday();

    function addMonthsAdjust(date, months) {
      const year = date.getFullYear();
      const month = date.getMonth();
      const day = date.getDate();
      const newMonth = month + months;
      const newDate = new Date(year, newMonth, 1);
      const lastDay = new Date(newDate.getFullYear(), newDate.getMonth() + 1, 0).getDate();
      return new Date(newDate.getFullYear(), newDate.getMonth(), Math.min(day, lastDay));
    }

    document.getElementById('generateBtn').addEventListener('click', () => {
      const batchCode = document.getElementById('batchCode').value.trim();
      const weekday = document.getElementById('weekday').value;
      const shelfMonths = parseInt(document.getElementById('shelfLife').value);
      const singleLine = document.getElementById('singleLineCheck').checked;
      const lineSelect = document.getElementById('lineSelect').value;
      if (batchCode.length !== 3) { alert('Nh·∫≠p m√£ l√¥ 3 k√Ω t·ª±'); return; }

      const expiry = addMonthsAdjust(new Date(), shelfMonths);
      const dd = String(expiry.getDate()).padStart(2, '0');
      const mm = String(expiry.getMonth() + 1).padStart(2, '0');
      const yy = String(expiry.getFullYear()).slice(2);
      const dateCode = dd + mm + yy;

      let result = '';
      if (singleLine) {
        result = `${dateCode} ${batchCode}${lineSelect}${weekday}`;
      } else {
        ['A','B','C','D','E','F','G','H','I'].forEach(line => {
          result += `${dateCode} ${batchCode}${line}${weekday}\n`;
        });
        result = result.trim();
      }
      targetTextArea.value = result;
    });

    document.getElementById('singleLineCheck').addEventListener('change', function() {
      document.getElementById('lineSelectWrapper').style.display = this.checked ? 'block' : 'none';
    });

    async function openCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        video.srcObject = stream;
      } catch (e) {
        alert('Kh√¥ng m·ªü ƒë∆∞·ª£c camera: ' + e);
      }
    }
    openCamera();

    // Adaptive Threshold ƒë∆°n gi·∫£n
    function preprocessImage(srcCanvas) {
      const scale = 3;
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = srcCanvas.width * scale;
      tempCanvas.height = srcCanvas.height * scale;
      const tctx = tempCanvas.getContext('2d');
      tctx.drawImage(srcCanvas, 0, 0, tempCanvas.width, tempCanvas.height);

      const imgData = tctx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
      const data = imgData.data;
      const windowSize = 15; // k√≠ch th∆∞·ªõc c·ª≠a s·ªï t√≠nh trung b√¨nh
      const grayArr = [];

      for (let i = 0; i < data.length; i += 4) {
        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
        grayArr.push(gray);
      }

      const getGray = (x, y) => grayArr[y * tempCanvas.width + x];

      for (let y = 0; y < tempCanvas.height; y++) {
        for (let x = 0; x < tempCanvas.width; x++) {
          let sum = 0, count = 0;
          for (let wy = -windowSize; wy <= windowSize; wy++) {
            for (let wx = -windowSize; wx <= windowSize; wx++) {
              const nx = x + wx, ny = y + wy;
              if (nx >= 0 && nx < tempCanvas.width && ny >= 0 && ny < tempCanvas.height) {
                sum += getGray(nx, ny);
                count++;
              }
            }
          }
          const avg = sum / count;
          const i = (y * tempCanvas.width + x) * 4;
          const val = (getGray(x, y) > avg - 15) ? 255 : 0;
          data[i] = data[i + 1] = data[i + 2] = val;
        }
      }
      tctx.putImageData(imgData, 0, 0);
      return tempCanvas;
    }

    document.getElementById('captureBtn').addEventListener('click', async () => {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const overlay = document.getElementById('overlay');
      const videoRect = video.getBoundingClientRect();
      const overlayRect = overlay.getBoundingClientRect();
      const scaleX = video.videoWidth / videoRect.width;
      const scaleY = video.videoHeight / videoRect.height;

      const cropX = (overlayRect.left - videoRect.left) * scaleX;
      const cropY = (overlayRect.top - videoRect.top) * scaleY;
      const cropW = overlayRect.width * scaleX;
      const cropH = overlayRect.height * scaleY;

      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = cropW;
      tempCanvas.height = cropH;
      const tctx = tempCanvas.getContext('2d');
      tctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

      const preCanvas = preprocessImage(tempCanvas);

      const { data: { text } } = await Tesseract.recognize(preCanvas, 'eng', {
        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz',
        tessedit_pageseg_mode: 7
      });

      const cleaned = text.trim().replace(/\s+/g, ' ');
      ocrTextDiv.innerText = cleaned;

      const targetLines = targetTextArea.value.split('\n').map(l => l.trim()).filter(l => l);
      const isMatch = targetLines.includes(cleaned);
      resultDiv.innerHTML = isMatch ? '‚úÖ ƒê√öNG' : '‚ùå SAI';
      resultDiv.className = isMatch ? 'ok': 'fail';
    });
  </script>
</body>
</html>
