<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>OCR Date Checker (OpenCV.js + Tesseract)</title>
<style>
:root{ --w: 340px; --h: 240px; }
body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7f9; margin:0; }
.wrap{ max-width:720px; margin:0 auto; padding:14px; }
h1{ font-size:20px; margin:10px 0; }
.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
label{ font-size:14px; color:#333; }
input, select, button, textarea{ font-size:14px; padding:10px; border-radius:10px; border:1px solid #dfe3ea; background:#fff; }
button{ cursor:pointer; border:none; background:#0a7cff; color:#fff; box-shadow:0 4px 12px rgba(10,124,255,.2); }
button:active{ transform:translateY(1px); }
textarea{ width:100%; min-height:120px; }
.camera{ position:relative; display:inline-block; }
video{ width:var(--w); height:var(--h); object-fit:cover; border-radius:12px; border:2px solid #e3e7ee; background:#000; }
#overlay{ position:absolute; border:2px dashed rgba(255,62,62,.9); border-radius:8px; pointer-events:none; width:160px; height:56px; top:50%; left:50%; transform:translate(-50%,-50%); box-shadow:0 0 12px rgba(255,62,62,.35); }
.mini{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:8px 0; }
.status{ font-weight:700; font-size:16px; }
.ok{ color:#1f9d55; } .fail{ color:#e11d48; } .muted{ color:#6b7280; font-weight:500; }
canvas{ display:none; }
.preview{ display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; margin-top:8px; }
.box{ background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:8px; }
.box h3{ margin:0 0 6px 0; font-size:13px; color:#374151; }
.box canvas{ display:block; width:220px; height:auto; border-radius:8px; }
.tip{ font-size:12px; color:#6b7280; }
</style>
</head>
<body>
<div class="wrap">
<h1>OCR Date Checker (OpenCV.js + Tesseract)</h1>

<div class="row">
  <label>H·∫°n d√πng (th√°ng)
    <select id="shelfLife"><option value="6">6</option><option value="9">9</option><option value="10">10</option></select>
  </label>
  <label>M√£ l√¥ (3 k√Ω t·ª±)
    <input id="batchCode" maxlength="3" placeholder="VD: 086" />
  </label>
  <label>Th·ª© h√¥m nay
    <input id="weekday" readonly style="width:60px" />
  </label>
  <label class="mini"><input type="checkbox" id="singleLineCheck" /> Ch·ªâ 1 line</label>
  <label id="lineSelectWrapper" style="display:none;">Line
    <select id="lineSelect"><option>A</option><option>B</option><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option><option>H</option><option>I</option></select>
  </label>
  <button id="generateBtn">T·∫°o danh s√°ch date</button>
</div>

<textarea id="dateList" placeholder="Danh s√°ch date code..."></textarea>

<div class="mini">
  <button id="openBtn">B·∫≠t camera</button>
  <button id="captureBtn">üì∑ Ch·ª•p & OCR</button>
  <button id="toggleAuto">Auto Scan: OFF</button>
  <span id="loader" class="muted">Templates: ch∆∞a t·∫£i</span>
</div>

<div class="camera">
  <video id="video" playsinline muted></video>
  <div id="overlay"></div>
</div>

<div class="mini">
  <span>K·∫øt qu·∫£:</span>
  <span id="result" class="status muted">‚Äî</span>
</div>
<div id="ocrText" class="tip"></div>

<canvas id="rawCanvas"></canvas>
<canvas id="cropCanvas"></canvas>
<canvas id="procCanvas"></canvas>

<div class="preview">
  <div class="box"><h3>Crop</h3><canvas id="cropPreview" width="220" height="100"></canvas></div>
  <div class="box"><h3>Processed</h3><canvas id="procPreview" width="220" height="100"></canvas></div>
</div>

<p class="tip">M·∫πo: ƒê·∫∑t khung ƒë·ªè v·ª´a kh√≠t d√£y m√£...</p>
</div>

<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script>
const $ = s => document.querySelector(s);
const video = $('#video'), overlay = $('#overlay'), resultDiv = $('#result'), ocrTextDiv = $('#ocrText');
const rawCanvas = $('#rawCanvas'), cropPrev = $('#cropPreview'), procPrev = $('#procPreview');
let autoScan = false, autoTimer = null, cvReady = false;

(function draggable(){
  let drag=false,sx=0,sy=0;
  overlay.addEventListener('mousedown',e=>{drag=true;sx=e.clientX;sy=e.clientY;});
  window.addEventListener('mousemove',e=>{if(!drag)return;const dx=e.clientX-sx,dy=e.clientY-sy;overlay.style.left=`calc(50% + ${dx}px)`;overlay.style.top=`calc(50% + ${dy}px)`;});
  window.addEventListener('mouseup',()=>drag=false);
})();
function updateWeekday(){const d=new Date();$('#weekday').value=(d.getDay()===0)?1:d.getDay()+1;}
updateWeekday();
function addMonthsAdjust(date,months){const y=date.getFullYear(),m=date.getMonth(),day=date.getDate(),nm=m+months;const nd=new Date(y,nm,1);const last=new Date(nd.getFullYear(),nd.getMonth()+1,0).getDate();return new Date(nd.getFullYear(),nd.getMonth(),Math.min(day,last));}

$('#generateBtn').addEventListener('click',()=>{
  const batch=$('#batchCode').value.trim(),wd=$('#weekday').value,mon=parseInt($('#shelfLife').value);
  if(batch.length!==3){alert('Nh·∫≠p m√£ l√¥ 3 k√Ω t·ª±');return;}
  const exp=addMonthsAdjust(new Date(),mon),dd=String(exp.getDate()).padStart(2,'0'),mm=String(exp.getMonth()+1).padStart(2,'0'),yy=String(exp.getFullYear()).slice(2);
  const dateCode=dd+mm+yy;let res='';
  if($('#singleLineCheck').checked){res=`${dateCode} ${batch}${$('#lineSelect').value}${wd}`;}
  else{['A','B','C','D','E','F','G','H','I'].forEach(L=>res+=`${dateCode} ${batch}${L}${wd}\n`);res=res.trim();}
  $('#dateList').value=res;
});
$('#singleLineCheck').addEventListener('change',function(){$('#lineSelectWrapper').style.display=this.checked?'inline-block':'none';});

async function openCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});
    video.srcObject=stream;await video.play();
    rawCanvas.width=video.videoWidth;rawCanvas.height=video.videoHeight;
  }catch(e){alert('Kh√¥ng m·ªü ƒë∆∞·ª£c camera: '+e.message);}
}
$('#openBtn').addEventListener('click',openCamera);

function onOpenCvReady(){cv.onRuntimeInitialized=()=>{cvReady=true;$('#loader').textContent='OpenCV: ready';};}

function getRoi(){
  const vRect=video.getBoundingClientRect(),oRect=overlay.getBoundingClientRect();
  const scaleX=video.videoWidth/vRect.width,scaleY=video.videoHeight/vRect.height;
  const x=Math.max(0,(oRect.left-vRect.left)*scaleX),y=Math.max(0,(oRect.top-vRect.top)*scaleY);
  const w=Math.min(video.videoWidth-x,oRect.width*scaleX),h=Math.min(video.videoHeight-y,oRect.height*scaleY);
  return {x:Math.round(x),y:Math.round(y),w:Math.round(w),h:Math.round(h)};
}

function processFrame(){
  if(!cvReady||video.readyState<2)return null;
  const rctx=rawCanvas.getContext('2d');rctx.drawImage(video,0,0,rawCanvas.width,rawCanvas.height);
  let src=cv.imread(rawCanvas),{x,y,w,h}=getRoi(),roi=src.roi(new cv.Rect(x,y,w,h));
  // preview crop
  cv.imshow(cropPrev,roi);
  let gray=new cv.Mat();cv.cvtColor(roi,gray,cv.COLOR_RGBA2GRAY,0);
  let up=new cv.Mat();cv.resize(gray,up,new cv.Size(0,0),3,3,cv.INTER_CUBIC);
  let blur=new cv.Mat();cv.GaussianBlur(up,blur,new cv.Size(3,3),0);
  let bin=new cv.Mat();cv.adaptiveThreshold(blur,bin,255,cv.ADAPTIVE_THRESH_GAUSSIAN_C,cv.THRESH_BINARY,21,10);
  let kernel=cv.getStructuringElement(cv.MORPH_RECT,new cv.Size(2,2)),opened=new cv.Mat();
  cv.morphologyEx(bin,opened,cv.MORPH_OPEN,kernel);
  let sharp=new cv.Mat(),openedBlur=new cv.Mat();
  cv.GaussianBlur(opened,openedBlur,new cv.Size(0,0),1.0);
  cv.addWeighted(opened,1.5,openedBlur,-0.5,0,sharp);
  const mean=cv.mean(sharp)[0];let proc=new cv.Mat();
  if(mean<127){cv.bitwise_not(sharp,proc);}else{proc=sharp.clone();}
  // preview processed
  cv.imshow(procPrev,proc);
  src.delete();roi.delete();gray.delete();up.delete();blur.delete();bin.delete();opened.delete();kernel.delete();openedBlur.delete();
  return proc;
}

function postProcess(text){
  let chars=text.split(''),regex=/^\d{6} \d{3}[A-I][1-7]$/;
  if(regex.test(text))return text;
  let changes=0;
  for(let i=0;i<chars.length;i++){
    if(i<=5&&!/[0-9]/.test(chars[i])){chars[i]='0';changes++;}
    if(i===6&&chars[i]!==' '){chars[i]=' ';changes++;}
    if(i>=7&&i<=9&&!/[0-9]/.test(chars[i])){chars[i]='0';changes++;}
    if(i===10&&!/[A-I]/.test(chars[i])){chars[i]='A';changes++;}
    if(i===11&&!/[1-7]/.test(chars[i])){chars[i]='1';changes++;}
  }
  const fixed=chars.join('');
  return changes<=2&&regex.test(fixed)?fixed:text;
}

async function runTesseract(procMat){
  const tmp=document.createElement('canvas');tmp.width=procMat.cols;tmp.height=procMat.rows;
  cv.imshow(tmp,procMat);
  const {data:{text}}=await Tesseract.recognize(tmp,'eng',{tessedit_char_whitelist:'0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ '});
  let cleaned=text.replace(/\s+/g,' ').trim().toUpperCase().replace(/[^0-9A-Z ]/g,'');
  return postProcess(cleaned);
}

async function captureOnce(){
  const procMat=processFrame();if(!procMat)return;
  const cleaned=await runTesseract(procMat);
  ocrTextDiv.textContent=cleaned;
  const targets=$('#dateList').value.split('\n').map(v=>v.trim()).filter(Boolean);
  const matched=targets.includes(cleaned);
  resultDiv.textContent=matched?'‚úÖ ƒê√öNG':'‚ùå SAI';
  resultDiv.className='status '+(matched?'ok':'fail');
  procMat.delete();
}
$('#captureBtn').addEventListener('click',captureOnce);

$('#toggleAuto').addEventListener('click',function(){
  autoScan=!autoScan;this.textContent='Auto Scan: '+(autoScan?'ON':'OFF');
  if(autoScan){
    const loop=async()=>{
      if(!autoScan)return;
      const procMat=processFrame();
      if(procMat){
        const cleaned=await runTesseract(procMat);
        ocrTextDiv.textContent=cleaned;
        const targets=$('#dateList').value.split('\n').map(v=>v.trim()).filter(Boolean);
        const matched=targets.includes(cleaned);
        resultDiv.textContent=matched?'‚úÖ ƒê√öNG':'‚ùå SAI';
        resultDiv.className='status '+(matched?'ok':'fail');
        procMat.delete();
      }
      autoTimer=setTimeout(loop,600);
    };
    loop();
  }else{if(autoTimer)clearTimeout(autoTimer);}
});
</script>
</body>
</html>
